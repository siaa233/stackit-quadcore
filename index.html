<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuickDesk - Created by QuadCore</title>
  <style>
    /* General beige theme */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f0e6;
      margin: 0; padding: 0;
      color: #4b4a3d;
      min-height: 100vh;
    }
    header {
      background: #c6b89c;
      padding: 1rem;
      text-align: center;
      font-weight: bold;
      font-size: 1.8rem;
      color: #382f1e;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    nav {
      display: flex;
      justify-content: center;
      background: #d7c9a3;
      padding: 0.5rem;
      gap: 1rem;
      position: sticky;
      top: 3.8rem;
      z-index: 90;
    }
    nav button {
      background: #b0a379;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      color: #382f1e;
      font-weight: 600;
      border-radius: 5px;
      transition: background 0.3s ease;
    }
    nav button:hover {
      background: #9a8f6e;
    }
    main {
      max-width: 900px;
      margin: 1rem auto 2rem auto;
      padding: 1rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px #aaa3;
    }
    h2, h3 {
      margin-top: 0;
      color: #5d4e2f;
    }
    form {
      margin: 1rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"],
    select,
    textarea {
      padding: 0.5rem;
      border: 1px solid #c6b89c;
      border-radius: 5px;
      font-size: 1rem;
      resize: vertical;
    }
    button {
      background: #a9986e;
      color: #382f1e;
      border: none;
      padding: 0.7rem;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #8c8256;
    }
    .hidden {
      display: none !important;
    }
    .notification {
      background: #d9c4a1;
      border: 1px solid #b9a57a;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 5px;
      color: #4a3e21;
      text-align: center;
      font-weight: 600;
      display: none;
    }
    /* Ticket cards */
    .ticket-card {
      border: 1px solid #c6b89c;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fbf7ed;
    }
    .ticket-card h3 {
      margin: 0 0 0.2rem 0;
      color: #6c5a2e;
    }
    .ticket-card h4 {
      margin: 0 0 0.5rem 0;
      color: #8b7d50;
      font-weight: 600;
    }
    .ticket-card p {
      margin: 0.3rem 0;
    }
    /* Thread message */
    .thread-message {
      border-bottom: 1px solid #c6b89c;
      padding: 0.4rem 0;
    }
    /* Profile avatar */
    #profile-avatar-preview {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #a9986e;
      margin-bottom: 1rem;
      background: #f0ead6;
    }
    /* Image for welcome */
    #welcome-image {
      width: 100%;
      max-height: 250px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 1rem;
      box-shadow: 0 4px 8px #b4a47a66;
    }
    /* Upvote/downvote buttons */
    .vote-buttons button {
      background: #d7c9a3;
      border: 1px solid #b0a379;
      margin-right: 0.5rem;
      font-weight: bold;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .vote-buttons button:hover {
      background: #b0a379;
      color: white;
    }
    /* Customer care */
    #customer-care {
      background: #fff3d9;
      border: 1px solid #d7c9a3;
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem 0 2rem 0;
      text-align: center;
      font-style: italic;
      color: #7a6b3f;
      box-shadow: 0 0 6px #d7c9a3aa;
    }
    /* Scroll for ticket list */
    #tickets-list, #agent-tickets-list {
      max-height: 350px;
      overflow-y: auto;
    }
    /* File input styling */
    input[type="file"] {
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>
  QuickDesk - Created by QuadCore
</header>

<nav id="top-nav">
  <button onclick="navigate('welcome')">Home</button>
  <button onclick="navigate('login')">Login</button>
  <button onclick="navigate('register')">Register</button>
</nav>

<div id="notifications" class="notification"></div>

<main>
  <!-- WELCOME -->
  <section id="welcome" class="section">
    <h2>Welcome to QuickDesk</h2>
    <img id="welcome-image" src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?auto=format&fit=crop&w=900&q=80" alt="Customer Support" />
    <p><strong>Your one-stop help desk solution.</strong></p>
    <p>"Helping you, faster and smarter."</p>
    <div id="customer-care">
      <strong>Customer Care:</strong> Call us at <a href="tel:+18005551234">1-800-555-1234</a> or email <a href="mailto:support@quickdesk.com">support@quickdesk.com</a>
    </div>
  </section>

  <!-- LOGIN -->
  <section id="login" class="section hidden">
    <h2>Login</h2>
    <form id="login-form" onsubmit="login(event)">
      <input type="email" id="login-email" placeholder="Email" required />
      <input type="password" id="login-password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <p>Don't have an account? <button onclick="navigate('register')" style="background:none;color:#a9986e; border:none;cursor:pointer;">Register here</button></p>
  </section>

  <!-- REGISTER -->
  <section id="register" class="section hidden">
    <h2>Register</h2>
    <form id="register-form" onsubmit="register(event)">
      <input type="text" id="register-name" placeholder="Full Name" required />
      <input type="email" id="register-email" placeholder="Email" required />
      <input type="password" id="register-password" placeholder="Password" required />
      <select id="register-role" required>
        <option value="" disabled selected>Select Role</option>
        <option value="user">End User</option>
        <option value="agent">Support Agent</option>
        <option value="admin">Admin</option>
      </select>
      <button type="submit">Register</button>
    </form>
    <p>Already have an account? <button onclick="navigate('login')" style="background:none;color:#a9986e; border:none;cursor:pointer;">Login here</button></p>
  </section>

  <!-- USER DASHBOARD -->
  <section id="user-dashboard" class="section hidden">
    <h2>My Tickets</h2>
    <div style="display:flex; gap: 1rem; flex-wrap: wrap; margin-bottom:1rem;">
      <input type="text" id="search-tickets" placeholder="Search tickets..." />
      <select id="filter-category">
        <option value="all">All Categories</option>
      </select>
      <select id="filter-status">
        <option value="all">All Statuses</option>
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Resolved">Resolved</option>
        <option value="Closed">Closed</option>
      </select>
      <select id="filter-sort">
        <option value="recent">Recently Modified</option>
        <option value="most_replied">Most Replied</option>
      </select>
    </div>
    <div id="tickets-list"></div>

    <button onclick="navigate('create-ticket')">Create New Ticket</button>
    <button onclick="navigate('profile')">My Profile</button>
    <button onclick="logout()">Logout</button>
  </section>

  <!-- CREATE TICKET -->
  <section id="create-ticket" class="section hidden">
    <h2>Create Ticket</h2>
    <form id="create-ticket-form" onsubmit="createTicket(event)">
      <input type="text" id="ticket-subject" placeholder="Subject" required />
      <textarea id="ticket-description" placeholder="Description" rows="4" required></textarea>
      <select id="ticket-category" required>
        <option value="" disabled selected>Select Category</option>
      </select>
      <input type="file" id="ticket-attachment" accept="image/*,application/pdf" />
      <button type="submit">Submit Ticket</button>
    </form>
    <button onclick="navigate('user-dashboard')">Back to Dashboard</button>
  </section>

  <!-- TICKET DETAIL -->
  <section id="ticket-detail" class="section hidden">
    <button onclick="navigate(currentUser.role === 'user' ? 'user-dashboard' : currentUser.role === 'agent' ? 'agent-dashboard' : 'admin-dashboard')">Back to Dashboard</button>
    <div id="ticket-detail-info" style="margin-top:1rem;"></div>

    <div class="vote-buttons" style="margin:1rem 0;">
      <button onclick="voteTicket(1)">üëç Upvote</button>
      <button onclick="voteTicket(-1)">üëé Downvote</button>
      <span id="vote-count" style="font-weight:bold; margin-left:0.5rem;"></span>
    </div>

    <h3>Comments</h3>
    <div id="ticket-thread" style="max-height: 200px; overflow-y:auto; background:#f9f7f2; padding:0.5rem; border-radius:6px; border: 1px solid #d3caa1;"></div>

    <form id="thread-form" onsubmit="addMessageToThread(event)" style="margin-top:1rem;">
      <textarea id="thread-message" rows="3" placeholder="Write a comment..." required></textarea>
      <button type="submit">Post Comment</button>
    </form>

    <!-- For agent/admin: update status and assign -->
    <div id="ticket-admin-controls" class="hidden" style="margin-top:1rem; border-top: 1px solid #c6b89c; padding-top: 1rem;">
      <h4>Admin/Agent Controls</h4>
      <button onclick="assignTicketToCurrentUser()">Assign to Me</button>
      <select id="status-select" onchange="updateTicketStatus(this.value)">
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Resolved">Resolved</option>
        <option value="Closed">Closed</option>
      </select>
    </div>
  </section>

  <!-- AGENT DASHBOARD -->
  <section id="agent-dashboard" class="section hidden">
    <h2>Agent Tickets</h2>
    <div style="margin-bottom:1rem;">
      <button onclick="navigate('create-ticket')">Create Ticket</button>
      <button onclick="navigate('profile')">My Profile</button>
      <button onclick="logout()">Logout</button>
    </div>
    <div id="agent-tickets-list" style="max-height:400px; overflow-y:auto;"></div>
  </section>

  <!-- ADMIN DASHBOARD -->
  <section id="admin-dashboard" class="section hidden">
    <h2>Admin Panel</h2>
    <div style="margin-bottom:1rem;">
      <button onclick="navigate('create-ticket')">Create Ticket</button>
      <button onclick="navigate('manage-users')">Manage Users</button>
      <button onclick="navigate('manage-categories')">Manage Categories</button>
      <button onclick="navigate('profile')">My Profile</button>
      <button onclick="logout()">Logout</button>
    </div>
    <div id="admin-tickets-list" style="max-height:400px; overflow-y:auto;"></div>
  </section>

  <!-- MANAGE USERS (ADMIN) -->
  <section id="manage-users" class="section hidden">
    <h2>User Management</h2>
    <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse; text-align:left;">
      <thead style="background:#d7c9a3;">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Bio</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="users-table-body"></tbody>
    </table>
    <button onclick="navigate('admin-dashboard')">Back to Admin Panel</button>
  </section>

  <!-- MANAGE CATEGORIES (ADMIN) -->
  <section id="manage-categories" class="section hidden">
    <h2>Category Management</h2>
    <form onsubmit="addCategory(event)" style="margin-bottom:1rem;">
      <input type="text" id="new-category-name" placeholder="New Category Name" required />
      <button type="submit">Add Category</button>
    </form>
    <ul id="categories-list" style="list-style:none; padding-left:0;"></ul>
    <button onclick="navigate('admin-dashboard')">Back to Admin Panel</button>
  </section>

  <!-- PROFILE -->
  <section id="profile" class="section hidden">
    <h2>My Profile</h2>
    <img id="profile-avatar-preview" src="" alt="Profile Avatar" />
    <form id="profile-form" onsubmit="updateProfile(event)">
      <label for="profile-avatar">Upload Avatar (Image only):</label>
      <input type="file" id="profile-avatar" accept="image/*" />
      <label for="profile-bio">Bio:</label>
      <textarea id="profile-bio" rows="4" placeholder="Tell us about yourself..."></textarea>
      <button type="submit">Update Profile</button>
    </form>
    <button onclick="navigate(currentUser.role + '-dashboard')">Back to Dashboard</button>
  </section>

</main>

<script>
  // DATA STORAGE KEYS
  const STORAGE_USERS = 'quickdesk_users';
  const STORAGE_TICKETS = 'quickdesk_tickets';
  const STORAGE_CATEGORIES = 'quickdesk_categories';
  const STORAGE_CURRENT_USER = 'quickdesk_current_user';

  // State variables
  let users = JSON.parse(localStorage.getItem(STORAGE_USERS)) || [];
  let tickets = JSON.parse(localStorage.getItem(STORAGE_TICKETS)) || [];
  let categories = JSON.parse(localStorage.getItem(STORAGE_CATEGORIES)) || ['Technical', 'Billing', 'General'];
  let currentUser = JSON.parse(localStorage.getItem(STORAGE_CURRENT_USER)) || null;
  let currentTicket = null;

  // --- NAVIGATION ---
  function navigate(sectionId) {
    // Hide all .section
    document.querySelectorAll('main .section').forEach(sec => sec.classList.add('hidden'));

    // Show requested section
    const section = document.getElementById(sectionId);
    if (section) section.classList.remove('hidden');

    // Update nav buttons visibility
    const nav = document.getElementById('top-nav');
    if (currentUser) {
      nav.innerHTML = `
        <button onclick="navigate('${currentUser.role}-dashboard')">Dashboard</button>
        <button onclick="navigate('profile')">Profile</button>
        <button onclick="logout()">Logout</button>
      `;
    } else {
      nav.innerHTML = `
        <button onclick="navigate('welcome')">Home</button>
        <button onclick="navigate('login')">Login</button>
        <button onclick="navigate('register')">Register</button>
      `;
    }

    // Render content for the current page
    if (sectionId === 'user-dashboard') renderUserDashboard();
    if (sectionId === 'agent-dashboard') renderAgentDashboard();
    if (sectionId === 'admin-dashboard') renderAdminDashboard();
    if (sectionId === 'manage-users') renderManageUsers();
    if (sectionId === 'manage-categories') renderManageCategories();
    if (sectionId === 'create-ticket') renderCategoriesDropdown();
    if (sectionId === 'profile') renderProfile();
    if (sectionId === 'ticket-detail') renderTicketDetail();
  }

  // --- NOTIFICATIONS ---
  function showNotification(msg) {
    const notif = document.getElementById('notifications');
    notif.textContent = msg;
    notif.style.display = 'block';
    setTimeout(() => {
      notif.style.display = 'none';
    }, 3500);
  }

  // --- SAVE TO LOCAL STORAGE ---
  function saveUsers() {
    localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
  }
  function saveTickets() {
    localStorage.setItem(STORAGE_TICKETS, JSON.stringify(tickets));
  }
  function saveCategories() {
    localStorage.setItem(STORAGE_CATEGORIES, JSON.stringify(categories));
  }
  function saveCurrentUser() {
    localStorage.setItem(STORAGE_CURRENT_USER, JSON.stringify(currentUser));
  }

  // --- REGISTER ---
  function register(event) {
    event.preventDefault();
    const name = document.getElementById('register-name').value.trim();
    const email = document.getElementById('register-email').value.trim().toLowerCase();
    const password = document.getElementById('register-password').value;
    const role = document.getElementById('register-role').value;

    if (users.find(u => u.email === email)) {
      alert('User with this email already exists.');
      return;
    }
    const newUser = { name, email, password, role, avatar: '', bio: '' };
    users.push(newUser);
    saveUsers();
    showNotification('Registration successful! Please login.');
    navigate('login');
  }

  // --- LOGIN ---
  function login(event) {
    event.preventDefault();
    const email = document.getElementById('login-email').value.trim().toLowerCase();
    const password = document.getElementById('login-password').value;
    const user = users.find(u => u.email === email && u.password === password);
    if (!user) {
      alert('Invalid email or password.');
      return;
    }
    currentUser = user;
    saveCurrentUser();
    showNotification(`Welcome, ${user.name}!`);
    navigate(user.role + '-dashboard');
  }

  // --- LOGOUT ---
  function logout() {
    currentUser = null;
    saveCurrentUser();
    navigate('welcome');
  }

  // --- RENDER CATEGORIES DROPDOWN ---
  function renderCategoriesDropdown() {
    const selectUser = document.getElementById('ticket-category');
    const selectFilter = document.getElementById('filter-category');

    // Clear existing
    selectUser.innerHTML = '<option value="" disabled selected>Select Category</option>';
    selectFilter.innerHTML = '<option value="all">All Categories</option>';

    categories.forEach(cat => {
      const option1 = document.createElement('option');
      option1.value = cat;
      option1.textContent = cat;
      selectUser.appendChild(option1);

      const option2 = document.createElement('option');
      option2.value = cat;
      option2.textContent = cat;
      selectFilter.appendChild(option2);
    });
  }

  // --- CREATE TICKET ---
  function createTicket(event) {
    event.preventDefault();
    const subject = document.getElementById('ticket-subject').value.trim();
    const description = document.getElementById('ticket-description').value.trim();
    const category = document.getElementById('ticket-category').value;
    const attachmentInput = document.getElementById('ticket-attachment');

    if (!subject || !description || !category) {
      alert('Please fill all required fields.');
      return;
    }

    // Process attachment file if exists
    if (attachmentInput.files.length > 0) {
      const file = attachmentInput.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        saveNewTicket(subject, description, category, reader.result);
      };
      reader.readAsDataURL(file);
    } else {
      saveNewTicket(subject, description, category, null);
    }
  }

  function saveNewTicket(subject, description, category, attachmentDataUrl) {
    const newTicket = {
      id: 't' + Date.now(),
      subject,
      description,
      category,
      status: 'Open',
      createdBy: currentUser.email,
      createdAt: Date.now(),
      updatedAt: Date.now(),
      assignedTo: null,
      attachment: attachmentDataUrl,
      thread: [],
      vote: 0,
      upvotes: [],
      downvotes: []
    };
    tickets.push(newTicket);
    saveTickets();
    showNotification('Ticket created successfully!');

    // Simulate email notification
    alert(`Email: Ticket "${subject}" created and is now Open.`);

    navigate(currentUser.role + '-dashboard');
  }

  // --- RENDER USER DASHBOARD ---
  function renderUserDashboard() {
    renderCategoriesDropdown();

    // Filters and search values
    const searchVal = document.getElementById('search-tickets').value.toLowerCase() || '';
    const categoryFilter = document.getElementById('filter-category').value;
    const statusFilter = document.getElementById('filter-status').value;
    const sortFilter = document.getElementById('filter-sort').value;

    // Filter tickets created by current user only
    let userTickets = tickets.filter(t => t.createdBy === currentUser.email);

    if (categoryFilter !== 'all') {
      userTickets = userTickets.filter(t => t.category === categoryFilter);
    }
    if (statusFilter !== 'all') {
      userTickets = userTickets.filter(t => t.status === statusFilter);
    }
    if (searchVal) {
      userTickets = userTickets.filter(t =>
        t.subject.toLowerCase().includes(searchVal) ||
        t.description.toLowerCase().includes(searchVal)
      );
    }

    // Sort tickets
    if (sortFilter === 'recent') {
      userTickets.sort((a,b) => b.updatedAt - a.updatedAt);
    } else if (sortFilter === 'most_replied') {
      userTickets.sort((a,b) => b.thread.length - a.thread.length);
    }

    const container = document.getElementById('tickets-list');
    container.innerHTML = '';

    if (userTickets.length === 0) {
      container.innerHTML = '<p>No tickets found.</p>';
      return;
    }

    userTickets.forEach(ticket => {
      const div = document.createElement('div');
      div.className = 'ticket-card';
      div.innerHTML = `
        <h3>${ticket.subject}</h3>
        <h4>Category: ${ticket.category} | Status: ${ticket.status}</h4>
        <p>${ticket.description.substring(0, 100)}${ticket.description.length > 100 ? '...' : ''}</p>
        <button onclick="viewTicket('${ticket.id}')">View Details</button>
      `;
      container.appendChild(div);
    });
  }

  // --- RENDER AGENT DASHBOARD ---
  function renderAgentDashboard() {
    renderCategoriesDropdown();

    // Show tickets assigned to this agent or open tickets
    const agentTickets = tickets.filter(t => t.assignedTo === currentUser.email || t.status === 'Open');

    const container = document.getElementById('agent-tickets-list');
    container.innerHTML = '';

    if (agentTickets.length === 0) {
      container.innerHTML = '<p>No tickets assigned or available.</p>';
      return;
    }

    agentTickets.forEach(ticket => {
      const div = document.createElement('div');
      div.className = 'ticket-card';
      div.innerHTML = `
        <h3>${ticket.subject}</h3>
        <h4>Category: ${ticket.category} | Status: ${ticket.status}</h4>
        <p>${ticket.description.substring(0, 100)}${ticket.description.length > 100 ? '...' : ''}</p>
        <button onclick="viewTicket('${ticket.id}')">View Details</button>
      `;
      container.appendChild(div);
    });
  }

  // --- RENDER ADMIN DASHBOARD ---
  function renderAdminDashboard() {
    renderCategoriesDropdown();

    const container = document.getElementById('admin-tickets-list');
    container.innerHTML = '';

    if (tickets.length === 0) {
      container.innerHTML = '<p>No tickets found.</p>';
      return;
    }

    tickets.forEach(ticket => {
      const div = document.createElement('div');
      div.className = 'ticket-card';
      div.innerHTML = `
        <h3>${ticket.subject}</h3>
        <h4>Category: ${ticket.category} | Status: ${ticket.status}</h4>
        <p>${ticket.description.substring(0, 100)}${ticket.description.length > 100 ? '...' : ''}</p>
        <button onclick="viewTicket('${ticket.id}')">View Details</button>
      `;
      container.appendChild(div);
    });
  }

  // --- VIEW TICKET DETAILS ---
  function viewTicket(ticketId) {
    currentTicket = tickets.find(t => t.id === ticketId);
    if (!currentTicket) {
      alert('Ticket not found.');
      return;
    }
    navigate('ticket-detail');
  }

  // --- RENDER TICKET DETAIL ---
  function renderTicketDetail() {
    if (!currentTicket) return;

    const detailSection = document.getElementById('ticket-detail');
    detailSection.innerHTML = `
      <h2>${currentTicket.subject}</h2>
      <p><strong>Category:</strong> ${currentTicket.category}</p>
      <p><strong>Status:</strong> ${currentTicket.status}</p>
      <p><strong>Description:</strong><br>${currentTicket.description}</p>
      ${currentTicket.attachment ? `<p><strong>Attachment:</strong><br><img src="${currentTicket.attachment}" alt="Attachment" style="max-width:300px;"/></p>` : ''}
      <p><strong>Created By:</strong> ${getUserByEmail(currentTicket.createdBy)?.name || currentTicket.createdBy}</p>
      <p><strong>Assigned To:</strong> ${currentTicket.assignedTo ? getUserByEmail(currentTicket.assignedTo)?.name : 'Unassigned'}</p>
      <p><strong>Created At:</strong> ${new Date(currentTicket.createdAt).toLocaleString()}</p>
      <p><strong>Last Updated:</strong> ${new Date(currentTicket.updatedAt).toLocaleString()}</p>

      <h3>Thread</h3>
      <div id="ticket-thread" style="max-height:200px; overflow-y:auto; border:1px solid #ccc; padding:0.5rem; margin-bottom:1rem;"></div>

      <form id="reply-form" onsubmit="addReply(event)">
        <textarea id="reply-text" rows="3" placeholder="Write your reply here..." required></textarea><br/>
        <button type="submit">Add Reply</button>
      </form>

      ${currentUser.role !== 'user' ? `
        <div style="margin-top:1rem;">
          <button onclick="assignTicketToCurrentUser()">Assign to Me</button>
          <select id="status-select" onchange="updateTicketStatus(this.value)">
            <option value="Open" ${currentTicket.status === 'Open' ? 'selected' : ''}>Open</option>
            <option value="In Progress" ${currentTicket.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
            <option value="Resolved" ${currentTicket.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
            <option value="Closed" ${currentTicket.status === 'Closed' ? 'selected' : ''}>Closed</option>
          </select>
        </div>
      ` : ''}

      <button onclick="navigate(currentUser.role + '-dashboard')" style="margin-top:1rem;">Back to Dashboard</button>
    `;

    renderThread();
  }

  // --- RENDER THREAD ---
  function renderThread() {
    const threadContainer = document.getElementById('ticket-thread');
    threadContainer.innerHTML = '';

    if (currentTicket.thread.length === 0) {
      threadContainer.innerHTML = '<p>No replies yet.</p>';
      return;
    }

    currentTicket.thread.forEach(reply => {
      const replyDiv = document.createElement('div');
      replyDiv.style.borderBottom = '1px solid #ddd';
      replyDiv.style.padding = '0.5rem 0';

      const author = getUserByEmail(reply.author)?.name || reply.author;
      const time = new Date(reply.createdAt).toLocaleString();

      replyDiv.innerHTML = `
        <p><strong>${author}</strong> <em>${time}</em></p>
        <p>${reply.text}</p>
      `;
      threadContainer.appendChild(replyDiv);
    });
  }

  // --- ADD REPLY ---
  function addReply(event) {
    event.preventDefault();
    const text = document.getElementById('reply-text').value.trim();
    if (!text) return alert('Reply cannot be empty.');

    const newReply = {
      id: 'r' + Date.now(),
      author: currentUser.email,
      text,
      createdAt: Date.now()
    };

    currentTicket.thread.push(newReply);
    currentTicket.updatedAt = Date.now();

    // Save changes
    saveTickets();
    renderTicketDetail();
    showNotification('Reply added successfully!');
  }

  // --- ASSIGN TICKET TO CURRENT USER ---
  function assignTicketToCurrentUser() {
    if (!currentTicket) return;
    currentTicket.assignedTo = currentUser.email;
    currentTicket.updatedAt = Date.now();
    saveTickets();
    renderTicketDetail();
    showNotification('Ticket assigned to you.');
  }

  // --- UPDATE TICKET STATUS ---
  function updateTicketStatus(status) {
    if (!currentTicket) return;
    currentTicket.status = status;
    currentTicket.updatedAt = Date.now();
    saveTickets();
    renderTicketDetail();
    showNotification(`Ticket status updated to ${status}.`);
  }

  // --- RENDER USER PROFILE ---
  function renderProfile() {
    if (!currentUser) return;
    document.getElementById('profile-avatar-preview').src = currentUser.avatar || 'https://via.placeholder.com/100';
    document.getElementById('profile-bio').value = currentUser.bio || '';
  }

  // --- UPDATE PROFILE ---
  function updateProfile(event) {
    event.preventDefault();
    const avatarInput = document.getElementById('profile-avatar');
    const bio = document.getElementById('profile-bio').value.trim();

    if (avatarInput.files.length > 0) {
      const file = avatarInput.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        currentUser.avatar = reader.result;
        currentUser.bio = bio;
        saveUserProfile();
      };
      reader.readAsDataURL(file);
    } else {
      currentUser.bio = bio;
      saveUserProfile();
    }
  }

  function saveUserProfile() {
    // Update users array
    const idx = users.findIndex(u => u.email === currentUser.email);
    if (idx !== -1) {
      users[idx] = currentUser;
      saveUsers();
      saveCurrentUser();
      showNotification('Profile updated successfully!');
      navigate(currentUser.role + '-dashboard');
    }
  }

  // --- MANAGE USERS (ADMIN) ---
  function renderManageUsers() {
    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = '';

    users.forEach(user => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${user.name}</td>
        <td>${user.email}</td>
        <td>${user.role}</td>
        <td>${user.bio || ''}</td>
        <td>
          <button onclick="deleteUser('${user.email}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteUser(email) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    users = users.filter(u => u.email !== email);
    saveUsers();
    renderManageUsers();
    showNotification('User deleted successfully.');
  }

  // --- MANAGE CATEGORIES (ADMIN) ---
  function renderManageCategories() {
    const ul = document.getElementById('categories-list');
    ul.innerHTML = '';
    categories.forEach(cat => {
      const li = document.createElement('li');
      li.style.marginBottom = '0.5rem';
      li.textContent = cat;
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.style.marginLeft = '1rem';
      delBtn.onclick = () => {
        if (confirm(`Delete category "${cat}"? This will not delete existing tickets.`)) {
          categories = categories.filter(c => c !== cat);
          saveCategories();
          renderManageCategories();
          showNotification('Category deleted.');
        }
      };
      li.appendChild(delBtn);
      ul.appendChild(li);
    });
  }

  function addCategory(event) {
    event.preventDefault();
    const newCat = document.getElementById('new-category-name').value.trim();
    if (!newCat) return alert('Category name cannot be empty.');
    if (categories.includes(newCat)) return alert('Category already exists.');
    categories.push(newCat);
    saveCategories();
    renderManageCategories();
    document.getElementById('new-category-name').value = '';
    showNotification('Category added successfully!');
  }

  // --- HELPERS ---
  function getUserByEmail(email) {
    return users.find(u => u.email === email);
  }

  // --- INITIALIZATION ---
  if (!currentUser) {
    navigate('welcome');
  } else {
    navigate(currentUser.role + '-dashboard');
  }
</script>
</body>
</html>
